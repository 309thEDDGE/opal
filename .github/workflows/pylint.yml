name: PyLint

on:
  push:
  pull_request:
    branches:
      - main

jobs:
  pylint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
    - name: Checkout code 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
        pip install setuptools>65.5.1 --force-reinstall
        pip install -r requirements.txt

    - name: Analysing the code with pylint
      run: |
        pylint $(git ls-files '*.py')


    - name: PyUp Safety Scan
      run: |
        pip install safety
        safety check

    - name: Run TruffleHog v3.22.0 (save results)
      run: |
        trufflehog git file://. \
          --since-commit ${{ github.event.repository.default_branch }} \
          --branch HEAD \
          --json > trufflehog_results.json
      continue-on-error: true

    - name: Install yq and jq
      run: |
        sudo apt-get update && sudo apt-get install -y jq
        curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o yq
        chmod +x yq
        sudo mv yq /usr/local/bin/yq

    - name: Apply allowlist filter
      run: |
        # Extract allowlist regexes and files from YAML
        regexes=$(yq '.regexes[]' trufflehog-allowlist.yaml | tr '\n' '|' || true)
        files=$(yq '.files[]' trufflehog-allowlist.yaml | tr '\n' '|' || true)

        echo "=== Raw Results ==="
        cat trufflehog_results.json | jq .

        echo "=== Filtered Results ==="
        cat trufflehog_results.json | jq \
          --arg regexes "$regexes" \
          --arg files "$files" \
          'map(select(.Raw | test($regexes) | not) | select(.File | test($files) | not))' \
          > filtered_results.json

        cat filtered_results.json

    - name: Fail if real secrets remain
      run: |
        count=$(jq 'length' filtered_results.json)
        if [ "$count" -gt 0 ]; then
          echo "❌ Found $count real secrets after allowlist filtering!"
          exit 1
        else
          echo "✅ No real secrets found after allowlist filtering."
        fi



